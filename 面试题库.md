# LowForm ä½ä»£ç è¡¨å•ç”Ÿæˆå™¨ - é¢è¯•é¢˜åº“

> åŸºäºé¡¹ç›®å®é™…åŠŸèƒ½ï¼šVue3 + TypeScript + Pinia + Element Plus + åŸç”Ÿ Drag API

---

## ä¸€ã€é¡¹ç›®æ¶æ„ä¸æ ¸å¿ƒè®¾è®¡

### 1. é¡¹ç›®çš„æ•´ä½“æ¶æ„æ˜¯æ€æ ·çš„ï¼Ÿè¯·ä»‹ç»ä¸€ä¸‹æ ¸å¿ƒæ¨¡å—

**ç­”æ¡ˆï¼š**

```
src/
â”œâ”€â”€ components/form-designer/
â”‚   â”œâ”€â”€ FormCanvas.vue         # ç”»å¸ƒ - æ‹–æ‹½æ”¾ç½®åŒºåŸŸ
â”‚   â”œâ”€â”€ ComponentPanel.vue     # å·¦ä¾§ç»„ä»¶é¢æ¿
â”‚   â”œâ”€â”€ PropertyPanel.vue      # å³ä¾§å±æ€§ç¼–è¾‘é¢æ¿
â”‚   â”œâ”€â”€ FieldWrapper.vue       # å­—æ®µåŒ…è£…å™¨
â”‚   â””â”€â”€ preview/
â”‚       â””â”€â”€ FormPreview.vue    # è¡¨å•é¢„è§ˆ
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ formStore.ts           # Pinia çŠ¶æ€ç®¡ç†
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ useDragDrop.ts         # æ‹–æ‹½é€»è¾‘
â”‚   â””â”€â”€ useHistory.ts          # æ’¤é”€/é‡åš
â”œâ”€â”€ types/
â”‚   â””â”€â”€ form.ts                # ç±»å‹å®šä¹‰
â””â”€â”€ views/
    â””â”€â”€ FormDesigner.vue       # ä¸»è§†å›¾
```

**æ ¸å¿ƒæµç¨‹ï¼š**
1. ComponentPanel æä¾›å¯æ‹–æ‹½çš„ç»„ä»¶åˆ—è¡¨
2. FormCanvas æ¥æ”¶æ‹–æ‹½ï¼Œè°ƒç”¨ formStore æ·»åŠ å­—æ®µ
3. ç‚¹å‡»å­—æ®µé€‰ä¸­ï¼ŒPropertyPanel æ˜¾ç¤ºç¼–è¾‘è¡¨å•
4. ä¿®æ”¹å±æ€§å®æ—¶æ›´æ–° schema
5. FormPreview æ ¹æ® schema æ¸²æŸ“å®é™…è¡¨å•

---

### 2. è¡¨å•æ•°æ®ç»“æ„æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**ç­”æ¡ˆï¼š**

**schema ç»“æ„ï¼š**

```typescript
interface FormSchema {
  fields: FormField[][]  // äºŒç»´æ•°ç»„ï¼Œæ¯è¡Œä¸€ä¸ªå­—æ®µæ•°ç»„
  config: {
    labelPosition: 'left' | 'top' | 'right'
    labelWidth: number
    // æ›´å¤šå…¨å±€é…ç½®
  }
}

interface FormField {
  id: string
  type: FieldType
  label: string
  span: number          // Element Plus çš„æ …æ ¼å®½åº¦ (1-24)
  props: Record<string, any>
  rules?: ValidationRule[]
}
```

**è®¾è®¡ç†ç”±ï¼š**
- ä½¿ç”¨äºŒç»´æ•°ç»„ `fields[][]` ç›´è§‚è¡¨ç¤ºå¤šè¡Œå¤šåˆ—å¸ƒå±€
- `span` å±æ€§é…åˆ Element Plus çš„æ …æ ¼ç³»ç»Ÿå®ç°å“åº”å¼å¸ƒå±€
- `props` å¯¹è±¡å­˜å‚¨ç»„ä»¶çš„ä»»æ„å±æ€§ï¼Œä¿æŒæ‰©å±•æ€§
- ç‹¬ç«‹çš„ `rules` æ•°ç»„å­˜æ”¾æ ¡éªŒè§„åˆ™ï¼Œä¸ UI ç»„ä»¶åˆ†ç¦»

---

### 3. formStore æ˜¯å¦‚ä½•ç®¡ç†è¡¨å•çŠ¶æ€çš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

```typescript
// stores/formStore.ts
export const useFormStore = defineStore('form', () => {
  // çŠ¶æ€
  const schema = shallowRef<FormSchema>({
    fields: [],
    config: { labelPosition: 'top', labelWidth: 100 }
  })
  
  const selectedField = ref<{ row: number; col: number } | null>(null)
  const undoStack = ref<FormSchema[]>([])
  const redoStack = ref<FormSchema[]>([])

  // æ–¹æ³•
  function addField(rowIndex: number, field: FormField) {
    saveHistory()
    schema.value.fields[rowIndex].push(field)
    triggerSchemaUpdate()  // æ‰‹åŠ¨è§¦å‘ shallowRef æ›´æ–°
  }

  function moveField(fromRow, fromCol, toRow, toCol) {
    // ç§»åŠ¨å­—æ®µé€»è¾‘
    triggerSchemaUpdate()
  }

  function deleteField(rowIndex, colIndex) {
    saveHistory()
    schema.value.fields[rowIndex].splice(colIndex, 1)
    triggerSchemaUpdate()
  }

  // ... æ’¤é”€/é‡åšå®ç°
})
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `shallowRef` å‡å°‘æ·±å±‚å“åº”å¼å¼€é”€
- æ‰‹åŠ¨è°ƒç”¨ `triggerRef` è§¦å‘æ›´æ–°
- undo/redo ä½¿ç”¨ä¸¤ä¸ªæ ˆå®ç°

---

## äºŒã€æ‹–æ‹½åŠŸèƒ½å®ç°

### 4. æ‹–æ‹½åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä½¿ç”¨äº†ä»€ä¹ˆæŠ€æœ¯ï¼Ÿ

**ç­”æ¡ˆï¼š**

**ä½¿ç”¨åŸç”Ÿ HTML5 Drag APIï¼š**

```typescript
// æ‹–æ‹½å¼€å§‹
const handleDragStart = (e: DragEvent, field: FormField) => {
  e.dataTransfer!.setData('application/json', JSON.stringify(field))
  e.dataTransfer!.effectAllowed = 'copy'
}

// æ‹–æ‹½ç»è¿‡
const handleDragOver = (e: DragEvent) => {
  e.preventDefault()
  e.dataTransfer!.dropEffect = 'copy'
  // è®¡ç®—æ’å…¥ä½ç½®ï¼ˆä¸Š/ä¸‹/å·¦/å³ï¼‰
  calculatePosition(e)
}

// æ‹–æ‹½æ”¾ç½®
const handleDrop = (e: DragEvent, rowIndex: number) => {
  e.preventDefault()
  const data = JSON.parse(e.dataTransfer!.getData('application/json'))
  formStore.addField(rowIndex, data)
}
```

**æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“çš„åŸå› ï¼š**
- æ›´çµæ´»æ§åˆ¶æ’å…¥ä½ç½®åˆ¤æ–­
- å‡å°‘é¡¹ç›®ä¾èµ–ä½“ç§¯
- å¯ä»¥æ·±å…¥ç†è§£æ‹–æ‹½åŸç†

---

### 5. å¦‚ä½•åˆ¤æ–­æ‹–æ‹½æ—¶çš„æ’å…¥ä½ç½®ï¼ˆä¸Š/ä¸‹/å·¦/å³ï¼‰ï¼Ÿ

**ç­”æ¡ˆï¼š**

```typescript
const calculatePosition = (
  e: DragEvent,
  targetEl: HTMLElement
): 'top' | 'bottom' | 'left' | 'right' => {
  const rect = targetEl.getBoundingClientRect()
  const x = e.clientX - rect.left
  const y = e.clientY - rect.top
  const centerX = rect.width / 2
  const centerY = rect.height / 2

  // ä¸Š25% -> topï¼Œä¸‹75% -> bottom
  if (y < centerY * 0.5) {
    return 'top'
  } else if (y > centerY * 1.5) {
    return 'bottom'
  } else if (x < centerX * 1.2) {
    return 'left'   // å·¦ä¾§åŒºåŸŸ
  } else {
    return 'right'  // å³ä¾§åŒºåŸŸ
  }
}
```

**å…³é”®ç‚¹ï¼š**
- é€šè¿‡è®¡ç®—é¼ æ ‡ä½ç½®ç›¸å¯¹äºç›®æ ‡å…ƒç´ ä¸­å¿ƒçš„ä½ç½®åˆ¤æ–­
- ä½¿ç”¨ç™¾åˆ†æ¯”é˜ˆå€¼è€Œéå›ºå®šåƒç´ ï¼Œæé«˜é€‚åº”æ€§
- è€ƒè™‘å…ƒç´ çš„å®é™…å®½é«˜æ¯”ä¾‹

---

### 6. è·¨è¡Œæ‹–æ‹½æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

```typescript
// FormCanvas.vue - handleFieldDrop
const handleFieldDrop = (
  e: DragEvent,
  fromRowIndex: number,
  fromColIndex: number,
  toRowIndex: number,
  toColIndex: number,
  position: 'left' | 'right'
) => {
  e.preventDefault()
  e.stopPropagation()  // é˜»æ­¢å†’æ³¡ï¼Œé¿å…é‡å¤å¤„ç†

  // è®¡ç®—å®é™…æ’å…¥ä½ç½®
  let finalColIndex = toColIndex
  if (position === 'right') {
    finalColIndex = toColIndex + 1
  }

  // è·¨è¡Œç§»åŠ¨
  if (fromRowIndex !== toRowIndex) {
    // ç›®æ ‡è¡Œå­—æ®µæ•°èŒƒå›´å†…çš„ä½ç½®æ‰å°Šé‡
    const targetRowLength = schema.value.fields[toRowIndex]?.length || 0
    if (finalColIndex > targetRowLength) {
      finalColIndex = targetRowLength  // è¶…å‡ºåˆ™æ”¾åˆ°æœ«å°¾
    }
  } else {
    // åŒè¡Œç§»åŠ¨éœ€è¦è°ƒæ•´ç´¢å¼•ï¼ˆç§»é™¤åå…ƒç´ å‰ç§»ï¼‰
    if (fromColIndex < finalColIndex) {
      finalColIndex--
    }
  }

  // æ‰§è¡Œç§»åŠ¨
  formStore.moveField(fromRowIndex, fromColIndex, toRowIndex, finalColIndex)
}
```

---

### 7. æ‹–æ‹½è¿‡ç¨‹ä¸­æœ‰å“ªäº›æ€§èƒ½ä¼˜åŒ–ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. èŠ‚æµå¤„ç† dragover äº‹ä»¶ï¼š**

```typescript
const DRAG_OVER_THROTTLE = 50  // 50ms é—´éš”
let lastDragOverTime = 0

const handleDragOver = (e: DragEvent) => {
  const now = Date.now()
  if (now - lastDragOverTime < DRAG_OVER_THROTTLE) {
    return
  }
  lastDragOverTime = now
  // ... å®é™…å¤„ç†é€»è¾‘
}
```

**2. ä½¿ç”¨ v-memo å‡å°‘é‡æ¸²æŸ“ï¼š**

```vue
<template>
  <div
    v-for="(field, colIndex) in row"
    :key="field.id"
    v-memo="[field.id, field.span, field.label]"
  >
    <!-- å­—æ®µå†…å®¹ -->
  </div>
</template>
```

**3. CSS GPU åŠ é€Ÿï¼š**

```css
.field-item {
  transform: translateZ(0);
  will-change: transform;
  backface-visibility: hidden;
}
```

---

## ä¸‰ã€æ’¤é”€/é‡åšå®ç°

### 8. æ’¤é”€/é‡åšåŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

```typescript
// å†å²è®°å½•æ ˆ
const undoStack = ref<FormSchema[]>([])
const redoStack = ref<FormSchema[]>([])

// ä¿å­˜å†å²
const saveHistory = () => {
  undoStack.value.push(JSON.parse(JSON.stringify(schema.value)))
  // é™åˆ¶æ ˆå¤§å°
  if (undoStack.value.length > 50) {
    undoStack.value.shift()
  }
  redoStack.value = []  // æ–°æ“ä½œåæ¸…ç©º redo æ ˆ
}

// æ’¤é”€
const undo = () => {
  if (undoStack.value.length === 0) return
  redoStack.value.push(JSON.parse(JSON.stringify(schema.value)))
  schema.value = undoStack.value.pop()!
}

// é‡åš
const redo = () => {
  if (redoStack.value.length === 0) return
  undoStack.value.push(JSON.parse(JSON.stringify(schema.value)))
  schema.value = redoStack.value.pop()!
}
```

**å…³é”®ç‚¹ï¼š**
- æ¯æ¬¡æ“ä½œå‰ä¿å­˜å¿«ç…§
- é™åˆ¶æ ˆå¤§å°é˜²æ­¢å†…å­˜æº¢å‡º
- ä½¿ç”¨ JSON.parse(JSON.stringify()) æ·±æ‹·è´

---

### 9. ä¸ºä»€ä¹ˆä½¿ç”¨ shallowRefï¼Ÿå®ƒå’Œ ref æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼š**

**shallowRef çš„ç‰¹ç‚¹ï¼š**
- åªç›‘å¬ `.value` çš„æ›¿æ¢
- ä¸ç›‘å¬å¯¹è±¡å†…éƒ¨å±æ€§çš„å˜åŒ–
- æ€§èƒ½æ›´å¥½ï¼Œé€‚åˆå¤§æ•°æ®å¯¹è±¡

```typescript
// ä½¿ç”¨ shallowRef
const schema = shallowRef<FormSchema>({
  fields: [],
  config: {}
})

// ä¿®æ”¹æ•°ç»„å†…å®¹ä¸ä¼šè§¦å‘æ›´æ–°
schema.value.fields.push(newField)  // âŒ ä¸ä¼šæ›´æ–°

// éœ€è¦æ‰‹åŠ¨è§¦å‘
import { triggerRef } from 'vue'
triggerRef(schema)  // âœ… å¼ºåˆ¶è§¦å‘æ›´æ–°
```

**é¡¹ç›®ä¸­è¿™æ ·åšçš„åŸå› ï¼š**
- è¡¨å• schema æ˜¯ä¸€ä¸ªå¤§çš„åµŒå¥—å¯¹è±¡
- æ¯æ¬¡ä¿®æ”¹éƒ½è§¦å‘æ·±å±‚å“åº”å¼å¼€é”€å¤§
- æ‰‹åŠ¨æ§åˆ¶æ›´æ–°æ—¶æœºæé«˜æ€§èƒ½

---

## å››ã€å±æ€§ç¼–è¾‘é¢æ¿

### 10. ç‚¹å‡»å­—æ®µåï¼Œå±æ€§é¢æ¿æ˜¯å¦‚ä½•æ˜¾ç¤ºå’Œç¼–è¾‘çš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

```typescript
// FormCanvas.vue - ç‚¹å‡»é€‰ä¸­
const handleSelect = (rowIndex: number, colIndex: number) => {
  selectedField.value = { row: rowIndex, col: colIndex }
}

// PropertyPanel.vue - ç›‘å¬é€‰ä¸­çŠ¶æ€
const selectedFieldData = computed(() => {
  if (!formStore.selectedField) return null
  const { row, col } = formStore.selectedField
  return formStore.schema.value.fields[row]?.[col]
})

// å±æ€§ä¿®æ”¹å®æ—¶æ›´æ–°
const updateField = (key: string, value: any) => {
  if (selectedFieldData.value) {
    selectedFieldData.value.props[key] = value
    formStore.triggerSchemaUpdate()
  }
}
```

---

### 11. ä¸åŒç±»å‹çš„å­—æ®µå¦‚ä½•æ˜¾ç¤ºä¸åŒçš„å±æ€§é…ç½®ï¼Ÿ

**ç­”æ¡ˆï¼š**

```typescript
// æ ¹æ®å­—æ®µç±»å‹è¿”å›ä¸åŒçš„å±æ€§é…ç½®è¡¨
const getPropertyConfig = (type: FieldType) => {
  const configMap: Record<FieldType, PropertyConfig[]> = {
    input: [
      { key: 'placeholder', label: 'å ä½ç¬¦', type: 'string' },
      { key: 'maxlength', label: 'æœ€å¤§é•¿åº¦', type: 'number' },
      { key: 'clearable', label: 'å¯æ¸…ç©º', type: 'boolean' }
    ],
    select: [
      { key: 'placeholder', label: 'å ä½ç¬¦', type: 'string' },
      { key: 'options', label: 'é€‰é¡¹', type: 'array' },
      { key: 'filterable', label: 'å¯æœç´¢', type: 'boolean' }
    ],
    // ...
  }
  return configMap[type] || []
}
```

---

## äº”ã€è¡¨å•é¢„è§ˆ

### 12. è¡¨å•é¢„è§ˆåŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

```vue
<!-- FormPreview.vue -->
<template>
  <el-form
    :model="formData"
    :label-position="schema.config.labelPosition"
    :label-width="schema.config.labelWidth + 'px'"
  >
    <el-row :gutter="20">
      <template v-for="(row, rowIndex) in schema.fields" :key="rowIndex">
        <el-col
          v-for="field in row"
          :key="field.id"
          :span="field.span"
        >
          <el-form-item :label="field.label" :prop="field.id">
            <!-- åŠ¨æ€ç»„ä»¶ -->
            <component
              :is="getFieldComponent(field.type)"
              v-model="formData[field.id]"
              v-bind="field.props"
            />
          </el-form-item>
        </el-col>
      </template>
    </el-row>
  </el-form>
</template>
```

**æ ¸å¿ƒï¼š**
- ä½¿ç”¨ `component` åŠ¨æ€ç»„ä»¶æ¸²æŸ“ä¸åŒå­—æ®µ
- `v-model` å®ç°åŒå‘ç»‘å®š
- `el-row/el-col` å®ç°æ …æ ¼å¸ƒå±€

---

## å…­ã€éš¾ç‚¹ä¸æŒ‘æˆ˜

### 13. å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„æœ€å¤§æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³çš„ï¼Ÿ

**å‚è€ƒå›ç­”ï¼š**

**æŒ‘æˆ˜1ï¼šè·¨è¡Œæ‹–æ‹½ä½ç½®è®¡ç®—ä¸å‡†ç¡®**

- **é—®é¢˜**ï¼šä»ç¬¬äºŒè¡Œæ‹–åˆ°ç¬¬ä¸€è¡Œæ—¶ï¼Œå­—æ®µæ€»æ˜¯æ’å…¥åˆ°æœ«å°¾
- **åŸå› **ï¼š`toColIndex` æ²¡æœ‰æ­£ç¡®é™åˆ¶åœ¨ç›®æ ‡è¡Œé•¿åº¦å†…
- **è§£å†³**ï¼šæ·»åŠ è¾¹ç•Œæ£€æŸ¥ï¼Œç¡®ä¿æ’å…¥ä½ç½®ä¸è¶…è¿‡ç›®æ ‡è¡Œå­—æ®µæ•°

```typescript
const targetRowLength = schema.value.fields[toRowIndex]?.length || 0
if (toColIndex > targetRowLength) {
  toColIndex = targetRowLength
}
```

**æŒ‘æˆ˜2ï¼šshallowRef å“åº”å¼é—®é¢˜**

- **é—®é¢˜**ï¼šä¿®æ”¹æ•°ç»„åè§†å›¾ä¸æ›´æ–°
- **åŸå› **ï¼š`shallowRef` ä¸ç›‘å¬æ·±å±‚å˜åŒ–
- **è§£å†³**ï¼šæ¯æ¬¡ä¿®æ”¹åè°ƒç”¨ `triggerRef(schema)`

**æŒ‘æˆ˜3ï¼šæ‹–æ‹½æ—¶é‡å¤æ·»åŠ å­—æ®µ**

- **é—®é¢˜**ï¼šæ‹–æ‹½ä¸€ä¸ªæ–°å­—æ®µï¼Œä¼šæ·»åŠ ä¸¤æ¬¡
- **åŸå› **ï¼šåŒæ—¶è§¦å‘äº† canvas çº§åˆ«å’Œ field çº§åˆ«çš„ drop äº‹ä»¶
- **è§£å†³**ï¼šä½¿ç”¨ `dropProcessed` æ ‡å¿—ä½ï¼Œé˜»æ­¢å†’æ³¡

---

### 14. å¦‚ä½•ä¿è¯æ‹–æ‹½æ’å…¥ä½ç½®åˆ¤æ–­çš„å‡†ç¡®æ€§ï¼Ÿ

**ç­”æ¡ˆï¼š**

**å¤šç»´åº¦åˆ¤æ–­ï¼š**

1. **åŒºåˆ†ç›®æ ‡ç±»å‹**ï¼šæ˜¯è¡Œçº§åˆ«è¿˜æ˜¯å­—æ®µçº§åˆ«
2. **è®¡ç®—ç›¸å¯¹ä½ç½®**ï¼šåŸºäºç›®æ ‡å…ƒç´ çš„ä¸­å¿ƒç‚¹
3. **æ‰©å¤§æ£€æµ‹èŒƒå›´**ï¼šå·¦ä¾§åˆ¤å®šåŒºåŸŸä»ä¸­å¿ƒç‚¹æ‰©å¤§åˆ° 1.2 å€

```typescript
// æ‰©å¤§ left åˆ¤æ–­èŒƒå›´
if (y < centerY * 0.3) {
  position = 'top'
} else if (y > centerY * 1.7) {
  position = 'bottom'
} else if (x < centerX * 1.2) {  // æ‰©å¤§å·¦ä¾§æ£€æµ‹
  position = 'left'
} else {
  position = 'right'
}
```

4. **æä¾›è§†è§‰åé¦ˆ**ï¼šå®æ—¶æ˜¾ç¤ºæ’å…¥æŒ‡ç¤ºå™¨

---

## ä¸ƒã€æ•°æ®åŒæ­¥

### 15. æ‹–æ‹½åè§†å›¾æ²¡æœ‰æ­£ç¡®æ›´æ–°ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ

**ç­”æ¡ˆï¼š**

å¯èƒ½åŸå› åŠæ’æŸ¥ï¼š

1. **shallowRef æœªè§¦å‘æ›´æ–°**
   - æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† `triggerSchemaUpdate()`

2. **span å€¼æœªé‡æ–°è®¡ç®—**
   - æ£€æŸ¥ `recalculateRowSpans` æ˜¯å¦è¢«è°ƒç”¨
   ```typescript
   const recalculateRowSpans = (rowIndex: number) => {
     const row = schema.value.fields[rowIndex]
     const newCount = row.length
     const newSpan = Math.floor(24 / newCount)
     row.forEach((f, idx) => {
       f.span = idx === newCount - 1 ? 24 - newSpan * (newCount - 1) : newSpan
     })
   }
   ```

3. **key å±æ€§é—®é¢˜**
   - ç¡®ä¿ `v-for` ä½¿ç”¨å”¯ä¸€ id ä½œä¸º key

---

## å…«ã€é¡¹ç›®ç»éªŒ

### 16. è¿™ä¸ªé¡¹ç›®æœ‰å“ªäº›å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Ÿ

**ç­”æ¡ˆï¼š**

**åŠŸèƒ½å±‚é¢ï¼š**
- æ”¯æŒæ›´å¤šç»„ä»¶ç±»å‹ï¼ˆæ—¥æœŸèŒƒå›´ã€çº§è”é€‰æ‹©ï¼‰
- è¡¨å•è”åŠ¨é€»è¾‘ï¼ˆå­—æ®µå€¼è”åŠ¨ï¼‰
- æ¨¡æ¿ä¿å­˜å’Œå¤ç”¨

**æ€§èƒ½å±‚é¢ï¼š**
- å¤§æ•°æ®é‡è™šæ‹Ÿæ»šåŠ¨
- ç»„ä»¶æŒ‰éœ€åŠ è½½
- Web Worker å¤„ç†å¤æ‚è®¡ç®—

**ä½“éªŒå±‚é¢ï¼š**
- é”®ç›˜å¿«æ·æ“ä½œ
- æ›´å¥½çš„æ‹–æ‹½åŠ¨ç”»
- æ’¤é”€/é‡åšå†å²å¯è§†åŒ–

---

### 17. å¦‚æœè®©ä½ é‡æ–°è®¾è®¡ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ

**ç­”æ¡ˆï¼š**

1. **ä½¿ç”¨çŠ¶æ€æœºï¼ˆXStateï¼‰** ç®¡ç†è¡¨å•çŠ¶æ€
2. **æ›´çµæ´»çš„ JSON Schema** æ”¯æŒåµŒå¥—å¸ƒå±€
3. **è€ƒè™‘ SSR/SSG** æé«˜é¦–å±åŠ è½½é€Ÿåº¦
4. **æ›´å®Œå–„çš„ç±»å‹å®šä¹‰** å’Œè‡ªåŠ¨åŒ–æµ‹è¯•

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§

### 18. é¡¹ç›®ä¸­æœ‰å“ªäº›æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. shallowRef å‡å°‘å“åº”å¼å¼€é”€ï¼š**

```typescript
// ä½¿ç”¨ shallowRef é¿å…æ·±å±‚å“åº”å¼è¿½è¸ª
const schema = shallowRef<FormSchema>({
  fields: [],
  config: {}
})

// éœ€è¦æ‰‹åŠ¨è§¦å‘æ›´æ–°
import { triggerRef } from 'vue'
const updateSchema = () => triggerRef(schema)
```

**2. v-memo å‡å°‘åˆ—è¡¨é‡æ¸²æŸ“ï¼š**

```vue
<template v-for="(row, rowIndex) in schema.fields" :key="rowIndex">
  <div
    v-for="(field, colIndex) in row"
    :key="field.id"
    v-memo="[field.id, field.span, field.label]"
  >
    <!-- å­—æ®µå†…å®¹ -->
  </div>
</template>
```

**3. CSS GPU åŠ é€Ÿï¼š**

```css
.field-item {
  transform: translateZ(0);
  will-change: transform;
  backface-visibility: hidden;
}
```

**4. èŠ‚æµ/é˜²æŠ–ï¼š**

```typescript
// dragover äº‹ä»¶èŠ‚æµ
const throttle = (fn: Function, delay: number) => {
  let lastTime = 0
  return (...args: any[]) => {
    const now = Date.now()
    if (now - lastTime >= delay) {
      lastTime = now
      fn(...args)
    }
  }
}

const handleDragOver = throttle((e: DragEvent) => {
  // å¤„ç†é€»è¾‘
}, 50)
```

**5. ç»„ä»¶æ‡’åŠ è½½ï¼š**

```typescript
// ä½¿ç”¨ defineAsyncComponent æ‡’åŠ è½½é¢„è§ˆç»„ä»¶
import { defineAsyncComponent } from 'vue'

const FormPreview = defineAsyncComponent(() =>
  import('./FormPreview.vue')
)
```

---

### 19. å¦‚ä½•è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Ÿå‹åŠ›æµ‹è¯•ä¸»è¦å…³æ³¨å“ªäº›æŒ‡æ ‡ï¼Ÿ

**ç­”æ¡ˆï¼š**

**å‹åŠ›æµ‹è¯•å®ç°ï¼š**

```typescript
const handleStressTest = async (fieldCount: number) => {
  const results = {
    addTime: 0,
    undoTime: 0,
    redoTime: 0,
    memory: 0
  }

  // 1. æµ‹è¯•æ·»åŠ å¤§é‡å­—æ®µ
  const startAdd = performance.now()
  for (let i = 0; i < fieldCount; i++) {
    formStore.addField(0, generateRandomField(i))
  }
  results.addTime = performance.now() - startAdd

  // 2. æµ‹è¯•æ’¤é”€æ€§èƒ½
  const startUndo = performance.now()
  for (let i = 0; i < fieldCount; i++) {
    formStore.undo()
  }
  results.undoTime = performance.now() - startUndo

  // 3. æµ‹è¯•é‡åšæ€§èƒ½
  const startRedo = performance.now()
  for (let i = 0; i < fieldCount; i++) {
    formStore.redo()
  }
  results.redoTime = performance.now() - startRedo

  // 4. å†…å­˜ä½¿ç”¨
  results.memory = performance.memory?.usedJSHeapSize || 0

  return results
}
```

**å…³æ³¨æŒ‡æ ‡ï¼š**

| æŒ‡æ ‡ | è¯´æ˜ | ä¼˜ç§€æ ‡å‡† |
|------|------|----------|
| æ“ä½œå“åº”æ—¶é—´ | å•æ¬¡æ“ä½œè€—æ—¶ | < 16ms |
| FPS | åŠ¨ç”»æµç•…åº¦ | > 50 FPS |
| å†…å­˜å ç”¨ | å †å†…å­˜ä½¿ç”¨ | < 100MB |
| é¦–æ¬¡æ¸²æŸ“æ—¶é—´ | FCP | < 1.5s |

**æ€§èƒ½è¯„çº§ï¼š**

```typescript
const calculateGrade = (time: number, count: number) => {
  const avgTime = time / count
  if (avgTime < 1) return 'A'  // ä¼˜ç§€
  if (avgTime < 5) return 'B'  // è‰¯å¥½
  if (avgTime < 10) return 'C' // ä¸€èˆ¬
  return 'D'                    // éœ€ä¼˜åŒ–
}
```

---

### 20. å¦‚æœé¡¹ç›®ä¸Šçº¿åå‡ºç° bugï¼Œå¦‚ä½•å¿«é€Ÿå®šä½é—®é¢˜ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼š**

```bash
# æ§åˆ¶å°åˆ†ç±»
- Console: æŸ¥çœ‹ JS é”™è¯¯å’Œæ—¥å¿—
- Network: æŸ¥çœ‹æ¥å£è¯·æ±‚çŠ¶æ€
- Application: æŸ¥çœ‹ LocalStorage/SessionStorage
```

**2. æ·»åŠ å…³é”®æ—¥å¿—ï¼š**

```typescript
// åœ¨å…³é”®æ“ä½œå¤„æ·»åŠ æ—¥å¿—
const moveField = (fromRow, fromCol, toRow, toCol) => {
  console.log('[moveField] ========== å¼€å§‹ ==========')
  console.log('[moveField] å­—æ®µ:', field.label)
  console.log('[moveField] ä»:', [fromRow, fromCol])
  console.log('[moveField] åˆ°:', [toRow, toCol])
  console.log('[moveField] ç§»åŠ¨å‰æ•°ç»„:', schema.value.fields)

  // ... æ“ä½œé€»è¾‘

  console.log('[moveField] æ’å…¥åæ•°ç»„:', schema.value.fields)
  console.log('[moveField] ========== ç»“æŸ ==========')
}
```

**3. Vue å¼€å‘è€…å·¥å…·ï¼š**

- æ£€æŸ¥ç»„ä»¶å±‚çº§
- æŸ¥çœ‹ Vuex/Pinia çŠ¶æ€
- æŸ¥çœ‹ç»„ä»¶ props å’Œ events

**4. å¸¸è§é—®é¢˜æ’æŸ¥ï¼š**

| é—®é¢˜ | å¯èƒ½åŸå›  |
|------|----------|
| è§†å›¾ä¸æ›´æ–° | shallowRef æœªè§¦å‘ / key é‡å¤ |
| æ ·å¼é”™ä¹± | span è®¡ç®—é”™è¯¯ / CSS å†²çª |
| æ‹–æ‹½å¤±æ•ˆ | äº‹ä»¶æœªé˜»æ­¢é»˜è®¤è¡Œä¸º |
| å†…å­˜æ³„æ¼ | æœªæ¸…ç†å®šæ—¶å™¨/äº‹ä»¶ç›‘å¬ |

---

### 21. å¦‚ä½•æ”¶é›†ç”¨æˆ·ç«¯çš„é”™è¯¯ä¿¡æ¯ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. å…¨å±€é”™è¯¯æ•è·ï¼š**

```typescript
// main.ts
// Vue é”™è¯¯æ•è·
app.config.errorHandler = (err, instance, info) => {
  console.error('Vue Error:', err)
  console.error('Component:', instance)
  console.error('Info:', info)

  // ä¸ŠæŠ¥é”™è¯¯
  reportError({
    type: 'vue',
    message: err.message,
    stack: err.stack,
    info,
    url: window.location.href
  })
}

// Promise æœªæ•è·é”™è¯¯
window.addEventListener('unhandledrejection', (event) => {
  console.error('Promise Error:', event.reason)
  reportError({
    type: 'promise',
    message: event.reason,
    url: window.location.href
  })
})

// èµ„æºåŠ è½½é”™è¯¯
window.addEventListener('error', (event) => {
  if (!event.target) return
  reportError({
    type: 'resource',
    target: event.target.tagName,
    src: (event.target as HTMLScriptElement).src,
    url: window.location.href
  })
})
```

**2. é”™è¯¯ä¸ŠæŠ¥æœåŠ¡ï¼š**

```typescript
const reportError = async (data: ErrorReport) => {
  try {
    await fetch('/api/error-report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ...data,
        userAgent: navigator.userAgent,
        timestamp: Date.now(),
        version: import.meta.env.VITE_APP_VERSION
      })
    })
  } catch (e) {
    console.error('Error report failed:', e)
  }
}
```

**3. å¼€æºæ–¹æ¡ˆæ¨èï¼š**

| æ–¹æ¡ˆ | ç‰¹ç‚¹ |
|------|------|
| Sentry | åŠŸèƒ½å…¨é¢ï¼Œæ”¯æŒ Vue/React |
| LogRocket | å½•åˆ¶ç”¨æˆ·æ“ä½œå›æ”¾ |
| Badger | è½»é‡çº§ï¼Œè‡ªå»ºæœåŠ¡ |
| FrontJS | å›½å†…è®¿é—®å¿« |

---

### 22. å¦‚ä½•ç›‘æ§å‰ç«¯æ€§èƒ½ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. Performance APIï¼š**

```typescript
const performanceMetrics = () => {
  const timing = performance.timing
  const metrics = {
    // å…³é”®æŒ‡æ ‡
    FCP: 0,        // First Contentful Paint
    LCP: 0,        // Largest Contentful Paint
    FID: 0,        // First Input Delay
    CLS: 0,        // Cumulative Layout Shift

    // è®¡ç®—
    pageLoadTime: timing.loadEventEnd - timing.navigationStart,
    domReadyTime: timing.domContentLoadedEventEnd - timing.navigationStart,
    firstPaint: performance.getEntriesByType('paint')[0]?.startTime
  }

  // ä½¿ç”¨ PerformanceObserver è·å– LCP/FID/CLS
  const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (entry.entryType === 'largest-contentful-paint') {
        metrics.LCP = entry.startTime
      }
      if (entry.entryType === 'first-input') {
        metrics.FID = entry.processingStart - entry.startTime
      }
    }
  })

  observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input'] })

  return metrics
}
```

**2. è‡ªå®šä¹‰æ€§èƒ½åŸ‹ç‚¹ï¼š**

```typescript
// è®°å½•æ“ä½œæ€§èƒ½
const measureOperation = (name: string, fn: Function) => {
  const start = performance.now()
  fn()
  const duration = performance.now() - start

  // ä¸ŠæŠ¥æ€§èƒ½æ•°æ®
  reportPerformance({
    name,
    value: duration,
    rating: duration < 50 ? 'good' : duration < 100 ? 'needs-improvement' : 'poor'
  })
}

// ä½¿ç”¨
measureOperation('addField', () => {
  formStore.addField(0, newField)
})
```

**3. Vitals æŒ‡æ ‡ï¼š**

| æŒ‡æ ‡ | å«ä¹‰ | è‰¯å¥½ | éœ€ä¼˜åŒ– |
|------|------|------|--------|
| LCP | æœ€å¤§å†…å®¹ç»˜åˆ¶ | < 2.5s | > 4s |
| FID | é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ | < 100ms | > 300ms |
| CLS | ç´¯ç§¯å¸ƒå±€åç§» | < 0.1 | > 0.25 |

---

### 23. å¦‚ä½•ä¼˜åŒ–å¤§æ•°æ®é‡ä¸‹çš„æ¸²æŸ“æ€§èƒ½ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. è™šæ‹Ÿæ»šåŠ¨ï¼š**

```typescript
// é€‚ç”¨äºå¤§é‡å­—æ®µï¼ˆ1000+ï¼‰çš„åœºæ™¯
import { useVirtualScroll } from '@vueuse/core'

const { container, list, scrollTo } = useVirtualScroll(
  computed(() => fields.value),
  { itemHeight: 80 }
)
```

**2. åˆ†é¡µ/æ‡’åŠ è½½ï¼š**

```typescript
// ä¸ä¸€æ¬¡æ¸²æŸ“æ‰€æœ‰å­—æ®µ
const VISIBLE_FIELDS = 50
const displayedFields = computed(() => {
  return fields.value.slice(0, visibleCount.value)
})

const loadMore = () => {
  visibleCount.value += VISIBLE_FIELDS
}
```

**3. Web Worker å¤„ç†å¤æ‚è®¡ç®—ï¼š**

```typescript
// worker.ts
self.onmessage = (e) => {
  const { type, data } = e.data
  if (type === 'calculate') {
    // å¤æ‚è®¡ç®—åœ¨ Worker ä¸­æ‰§è¡Œ
    const result = heavyCalculation(data)
    self.postMessage({ type: 'result', data: result })
  }
}

// ä½¿ç”¨
const worker = new Worker(new URL('./worker.ts', import.meta.url))
worker.postMessage({ type: 'calculate', data: hugeData })
```

**4. æ–‡æ¡£ç¢ç‰‡æ‰¹é‡æ›´æ–°ï¼š**

```typescript
// å‡å°‘é‡æ’é‡ç»˜
const batchUpdate = (fields: FormField[]) => {
  const fragment = document.createDocumentFragment()

  fields.forEach(field => {
    const el = createFieldElement(field)
    fragment.appendChild(el)
  })

  container.appendChild(fragment)  // ä¸€æ¬¡ DOM æ“ä½œ
}
```

---

> ğŸ’¡ **é¢è¯•å»ºè®®**ï¼šç»“åˆè‡ªå·±çš„å®é™…å¼€å‘ç»å†æ¥è¯´ï¼Œæè¿°å…·ä½“é—®é¢˜å’Œä½ æ˜¯å¦‚ä½•è§£å†³çš„ï¼Œè¿™æ ·æ›´æœ‰è¯´æœåŠ›ã€‚
